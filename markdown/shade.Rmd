---
## "Sun v Shade leaves (WTCIII)"
author: "Court Campany"
date: "March 17, 2015"
output: html_document
---
```{r knitr_options , include=FALSE}
knitr::opts_chunk$set(fig.width=6, fig.height=6,
echo=FALSE, message=FALSE,
fig.align='center', warning=FALSE)
```

```{r, results='asis', echo=FALSE}
library(knitr)
opts_knit$set(root.dir = '../')
```

### Shade versus Sun leaves

This set of figures attempts to show that sun and shade leaves were different on multiple levels.  


* ACI curves were measured at saturating light for both sun and shade leaves.   



```{r, results='asis'}
library(pander)

aci_leaf <- read.csv("calculated_data/tdl_aci.csv")
names(aci_leaf) <-c("Leaf", "Temperature", "Vcmax", "Jmax", "Vcmax_se", "Jmax_se")

aci_leaf2 <- aci_leaf[,c(1,2,3,5,4,6)]

panderOptions("digits", 2)
pander(aci_leaf2, caption="Leaf Biochemistry")
```    

  
* Here are some predicted ACI curves for sun/shade with temperature treatements.  Both Vcmax and Jmax are reduced in shade leaves with little effect of treatment. Aci curves were only taken once towards the end of the experiment on well watered trees.    



```{r,results='asis'}

source("functions and packages/functions.R")
source("master_scripts/plot_objects.R")
aci_leaf <- read.csv("calculated_data/tdl_aci.csv")

#simulated curves
  library(plantecophys)

  #simulate ACi curves for each leaf, ambient and elevated T
  sunAT_sim <- Aci(Ci=seq(50,1000,length=101), Vcmax=aci_leaf[3,3], Jmax=aci_leaf[3,4],PPFD=1408)
  sunET_sim <- Aci(Ci=seq(50,1000,length=101), Vcmax=aci_leaf[4,3], Jmax=aci_leaf[4,4], PPFD=1408)
  shaAT_sim <- Aci(Ci=seq(50,1000,length=101), Vcmax=aci_leaf[1,3], Jmax=aci_leaf[1,4], PPFD=375)
  shaET_sim <- Aci(Ci=seq(50,1000,length=101), Vcmax=aci_leaf[2,3], Jmax=aci_leaf[2,4],PPFD=375)

#plot
plot(sunAT_sim$Ci, sunAT_sim$ALEAF, col="forestgreen", pch=21,  cex=1.1,xlab=cilab, ylab="", type="l", lwd=2)
  points(sunET_sim$Ci, sunET_sim$ALEAF, col="forestgreen", pch=21,  cex=1.1,xlab="Ci", ylab="", type="l", lwd=2, lty=2)
  points(shaAT_sim$Ci, shaAT_sim$ALEAF, col="yellowgreen", pch=21,  cex=1.1,xlab="Ci", ylab="", type="l", lwd=2)
  points(shaET_sim$Ci, shaET_sim$ALEAF, col="yellowgreen", pch=21,  cex=1.1,xlab="Ci", ylab="", type="l", lwd=2, lty=2)
  legend("bottomright", leglab2, lty=c(1,2,1,2), lwd=2,col=colaci, pt.bg=col4,inset = 0.03)
  title(ylab=satlab, mgp=ypos)


```

    
* This figure shows the relationship between leaf N on an area basis and carbon isotope dicrimination between leaf types.
    

```{r,results='asis'}
source("master_scripts/plot_objects.R")
leaftraits <- read.csv("calculated_data/leaftraits_summary.csv")
##this has droughtleaves

palette(c("yellowgreen", "green4"))

plot(c13.mean ~ leafN_area.mean, data=leaftraits, pch=16, col=as.factor(leaf), ylim=c(-35,-25), 
                 xlim=c(1,3.5), cex=1.25, xlab=narealab, ylab=c13lab)
legend("bottomright", leaflab, pch=16, col=c("yellowgreen", "green4"),pt.cex=1.5,inset = 0.03)  

```

* Next I show the light environment in which gas exchange measurements for sun and shade leaves were measured.  This data was generated with a handheld par sensor for each individual leaf level and verified with ceptometer readings within at the height of the measured leaf. There was on average a ~75 reduction in PPFD from sun to shave leaves.

* The second figure shows leaf mass area for each gas exchange campaign.  Here there 

```{r,results='asis'}
 source("functions and packages/functions.R")
 source("master_scripts/plot_objects.R")
 library(doBy)
 library(xtable)
 ####PPFD-----------------------------------------------------------------------------------------------
 par <- read.csv("raw data/par.csv")
 treatments <- read.csv("raw data/chamber_trt.csv")
 
 #format function
 par<- parformat(par)
 
 par_leaf <- subset(par, ID !="shade-high")
 Morder <- c("Oct", "Dec", "Jan", "Feb", "Mar", "Apr")
 
 #data format for bar
 parbar <- subset(par_leaf, select = c("par", "month", "leaf_type"))
 parbar$month <- factor(parbar$month, levels = Morder)
 
 
 bar(par, c(leaf_type, month), parbar, col=c("yellowgreen", "green4"), xlab="", ylab="", ylim=c(0, 2000), 
     half.errbar=FALSE)
 title(ylab=parlab, mgp=ypos)
 
 
 
 ###LMA--------------------------------------------------------------------------------------------------
 lma <- read.csv("calculated_data/leaf_chemistry.csv")
 
 #data format for bar
 lmabar <- subset(lma, select = c("lma", "Month", "leaf"))
   lmabar$Month <- factor(lmabar$Month, levels = Morder)
 
 bar(lma, c(leaf, Month), lmabar, col=c("yellowgreen", "green4"), xlab="", ylab="", ylim=c(0, 185), half.errbar=FALSE)
 title(ylab=lmalab, mgp=ypos)
 
 ##table summ by treatment
   lma_agg <- summaryBy(lma~ leaf+temp+drydown, data=lma, FUN=c(mean,se))
   lma_agg2 <- summaryBy(lma~ leaf+temp, data=lma, FUN=c(mean,se))
   
   lma_table <- xtable(lma_agg2)
 
```


## Mesophyll Conducatnce

* Below are means and standard errors of gm across all campaigns.

* We took leaf measurements at their current temperature (ambient, +3) in order to do paired comparisons across leaves at a large range of temperatures.  Im working on the paired comparisons now, but for this we will just focus on overall differences between leaf types.

* Further analysis is thus needed to tease apart any effects of temperature treatment as these are just the overall means over the 6 campaigns


####gm by leaf type and light environment

* Gm was calculated with Rd and Gstar generated for E.globulus.  Kristine Crous and I have compared tobacco with globulus calculations on FACE trees and they tend to lower the values of gm and generate less variance within a sample. I can easily alter the code to generate values with tobacco parameters if needed.

* Here i seperated the well watered treatment from the drought treatment.  Im much more confident in the well watered trees as I was often on the border with drawdown and xsi for droughted leave. They do so similar patterns

* Shade gm is always lower than sun leaves but when the lights are turned on they have in instantenous response in gm that resembles sun leaves


```{r,results='asis'}
 source("functions and packages/functions.R")
 library(doBy)
 
 gmes <- read.csv("calculated_data/gmes_WTC.csv")
 
 ###for analysis first subset well watered and drought treatments
 gm_drought <- gmes[gmes$drydown == "drought",]
 gm_water <- gmes[gmes$drydown == "control",]
 
###make a table of means and se of gm
 
 gm_agg <- summaryBy(gm~ leaf+light+temp+leaflight, data=gm_water,FUN=c(mean,se))
  Lorder <- c("shade-low", "sun-high", "shade-high")
  gm_agg$leaflight <- factor(gm_agg$leaflight, levels = Lorder)

   tablenames <- c( "Leaf Type", "Light", "Temperature","leaflight","Gm", "Gm(se)")
   names(gm_agg) <- tablenames

  
panderOptions("digits", 3)
pander(gm_agg,caption="Well Watered")
   
  gm_dr <- summaryBy(gm~ leaf+light+temp+leaflight, data=gm_drought,FUN=c(mean,se))
  Lorder <- c("shade-low", "shade-low","sun-high", "sun-high","shade-high","shade-high")
  gm_dr$leaflight <- factor(gm_dr$leaflight, levels = Lorder)
  tablenames <- c( "Leaf Type", "Light", "Temperature","Leaf-Light","Gm", "Gm(se)")
  names(gm_dr) <- tablenames
  
pander(gm_dr,caption="Drought")
 
```

* Next, Ill just show means of sun and shade leaf physiology and keep it simple by ignoring the temperature treatment. We can address that later.



```{r}
source("functions and packages/functions.R")
source("master_scripts/plot_objects.R")
source("functions and packages/packages.R")

#read in gm data set (no drought)

gmes <- read.csv("calculated_data/gmes_wellwatered.csv")
Ci_bar <- read.csv("calculated_data/Ci_bar.csv")

##calculate CC
gmes$Cc<- with(gmes, Ci-Photo/gm)
gmes$cc_ci<- with(gmes, Ci/Cc)

###get average by id
gm_agg <- summaryBy(Photo+Cond+Ci+Cc+gm+VpdL+xsi+DELTA+cc_ci ~ chamber+id+leaf +light+temp+leaflight, 
                    data=gmes, FUN=mean, keep.names=TRUE)


##remove shade-high
gm_sunsha <- gm_agg[gm_agg$leaflight != "shade-high",]
  gm_sunsha <- droplevels(gm_sunsha)
  gm_sunsha$id <- gsub("-high", "", gm_sunsha$id)
  gm_sunsha$id <- gsub("-low", "", gm_sunsha$id)

##merge
gm_c13 <- merge(gm_sunsha, Ci_bar[, c(2,8)], by="id")
  gm_c13$Cc_bar <- with(gm_c13, ci_bar-Photo/gm)

  
###Photosynthesis vs gs (need to fit sun with something else)------------------------------------------------
  library(mgcv)
  library(lme4)
  
  palette(c(shacol, suncol))

  ####run gam models and then predict
  #SUN leaves
  sunmod <- gam(Photo ~ s(Cond, k=5), data=gm_c13, subset=leaflight=="sun-high")
  
  #predict
  #get apprpriate vector of gs from sun leaves
  gsdat <- gm_c13[gm_c13$leaflight=="sun-high", "Cond"]
  
  #generate sequence and then predict
  gssun_seq <- seq(min(gsdat), max(gsdat), length=101)
  gssun_pred <- predict(sunmod, newdata=data.frame(Cond=gssun_seq), se.fit=TRUE)
  
  #ci and model fit
  sunupr <- gssun_pred$fit + (2*gssun_pred$se.fit)
  sunlwr <- gssun_pred$fit - (2*gssun_pred$se.fit)
  
  #SHADE leaves
  shamod <- gam(Photo ~ s(Cond, k=5), data=gm_c13, subset=leaflight=="shade-low")
  
  #get apprpriate vector CC from sun leaves
  gsdat2 <- gm_c13[gm_c13$leaflight=="shade-low", "Cond"]
  #generate sequence and then predict
  gssha_seq <- seq(min(gsdat2), max(gsdat2), length=101)
  gssha_pred <- predict(shamod, newdata=data.frame(Cond=gssha_seq), type="link", se.fit=TRUE)
  
  shaupr <- gssha_pred$fit + (2*gssha_pred$se.fit)
  shalwr <- gssha_pred$fit - (2*gssha_pred$se.fit)
  
  ###plot
  plot(Photo~Cond, data=gm_c13, subset=leaflight=="sun-high", pch=16, col=suncol, ylim=c(0,25), 
       xlim=c(0,.4), xlab=condlab, ylab="", cex=1.25)
  
  lines(gssun_seq, sunupr, lty=2, lwd=2,col=suncol)
  lines(gssun_seq, sunlwr, lty=2, lwd=2,col=suncol)
  lines(gssun_seq, gssun_pred$fit, lty=1, lwd=2,col=suncol)
  
  #shade
  points(Photo~Cond, data=gm_c13, subset=leaflight=="shade-low", pch=16, col=shacol, cex=1.25)
  lines(gssha_seq, shaupr, lty=2, lwd=2,col=shacol)
  lines(gssha_seq, shalwr, lty=2, lwd=2,col=shacol)
  lines(gssha_seq, gssha_pred$fit, lty=1, lwd=2,col=shacol)
  
  title(ylab=satlab, mgp=ypos, cex=1.2)
  legend("topleft", leaflab2, pch=16,inset = 0.03, col=leafcol) 
  
###Photosynthesis vs Ci--------------------------------------------------------------------------------

#SUN leaves
Aci_sun_lm <- lm(Photo~ Ci, data=gm_c13,subset=leaflight=="sun-high")

  #predict
  #get apprpriate vector CC from sun leaves
  cidat <- gm_c13[gm_c13$leaflight=="sun-high", "Ci"]
  #generate sequence and then predict
  cisun_seq <- seq(min(cidat), max(cidat), length=101)
  cisun_pred <- predict.lm(Aci_sun_lm, newdata=data.frame(Ci=cisun_seq), interval="confidence")

#SHADE leaves
Aci_shade_lm <- lm(Photo~ Ci, data=gm_c13, subset=leaflight=="shade-low")
  
  #get apprpriate vector CC from sun leaves
  cidat2 <- gm_c13[gm_c13$leaflight=="shade-low", "Ci"]
  #generate sequence and then predict
  cisha_seq <- seq(min(cidat2), max(cidat2), length=101)
  cisha_pred <- predict.lm(Aci_shade_lm, newdata=data.frame(Ci=cisha_seq), interval="confidence")


plot(Photo~Ci, data=gm_c13, subset=leaflight=="sun-high", pch=16, col=suncol, ylim=c(0,25), 
     xlim=c(0,350), xlab=cilab, ylab="", cex=1.25)
  ablineclip(Aci_sun_lm, lty=1, x1=min(gm_c13[gm_c13$leaf=="sun","Ci"]), x2=max(gm_c13[gm_c13$leaf=="sun","Ci"]), 
             col="forestgreen", lwd=2)
  lines(cisun_seq, cisun_pred[,2], lty=2, lwd=2, col="forestgreen")
  lines(cisun_seq, cisun_pred[,3], lty=2, lwd=2, col="forestgreen")
  #shade
  points(Photo~Ci, data=gm_c13, subset=leaflight=="shade-low", pch=16, col=shacol, cex=1.25)

  ablineclip(Aci_shade_lm, lty=1, x1=min(gm_c13[gm_c13$leaflight=="shade-low","Ci"]), 
             x2=max(gm_c13[gm_c13$leaflight=="shade-low","Ci"]), col="yellow4", lwd=2)
  lines(cisha_seq, cisha_pred[,2], lty=2, lwd=2,col="yellow4")
  lines(cisha_seq, cisha_pred[,3], lty=2, lwd=2,col="yellow4")
  
  title(ylab=satlab, mgp=ypos, cex=1.2)
  legend("topright", leaflab2, pch=16,inset = 0.03, col=leafcol)   
  
  
###Photosynthesis vs Cc  
  #SUN leaves
  ##photo not different by temp treatment, so not used
Acc_sun_lm <- lm(Photo~ Cc, data=gm_c13,subset=leaflight=="sun-high")

  ##instead predict Photo over a sequence of CC using the model fit

  #get apprpriate vector CC from sun leaves
  ccdat <- gm_c13[gm_c13$leaflight=="sun-high", "Cc"]
  #generate sequence and then predict
  ccsun_seq <- seq(min(ccdat), max(ccdat), length=101)
  ccsun_pred <- predict.lm(Acc_sun_lm, newdata=data.frame(Cc=ccsun_seq), interval="confidence")

#SHADE leaves
Acc_shade_lm <- lm(Photo~ Cc, data=gm_c13,subset=leaflight=="shade-low")

  #get apprpriate vector CC from sun leaves
  ccdat2 <- gm_c13[gm_c13$leaflight=="shade-low", "Cc"]
  #generate sequence and then predict
  ccsha_seq <- seq(min(ccdat2), max(ccdat2), length=101)
  ccsha_pred <- predict.lm(Acc_shade_lm, newdata=data.frame(Cc=ccsha_seq), interval="confidence")


##plot
plot(Photo~Cc, data=gm_c13, subset=leaflight=="sun-high", pch=16, col=suncol, ylim=c(0,25), 
     xlim=c(0,350), xlab=cclab, ylab="", cex=1.25)
  ablineclip(Acc_sun_lm, lty=1, x1=min(gm_c13[gm_c13$leaf=="sun","Cc"]), x2=max(gm_c13[gm_c13$leaf=="sun","Cc"]), 
           col="forestgreen", lwd=2)
  lines(ccsun_seq, ccsun_pred[,2], lty=2, lwd=2, col="forestgreen")
  lines(ccsun_seq, ccsun_pred[,3], lty=2, lwd=2, col="forestgreen")
  #shade
  points(Photo~Cc, data=gm_c13, subset=leaflight=="shade-low", pch=16, col=shacol, cex=1.25)
  ablineclip(Acc_shade_lm, lty=1, x1=min(gm_c13[gm_c13$leaflight=="shade-low","Cc"]), 
             x2=max(gm_c13[gm_c13$leaflight=="shade-low","Cc"]), col="yellow4", lwd=2)
  lines(ccsha_seq, ccsha_pred[,2], lty=2, lwd=2,col="yellow4")
  lines(ccsha_seq, ccsha_pred[,3], lty=2, lwd=2,col="yellow4")

  title(ylab=satlab, mgp=ypos, cex=1.2)
  legend("topright", leaflab2, pch=16,inset = 0.03, col=leafcol) 
  
  
  
  ###Photosynthesis vs gm-------------------------------------------------------------------------------

#SUN leaves
Agm_sun_lm <- lm(Photo~ gm, data=gm_c13,subset=leaflight=="sun-high")

#predict
#get apprpriate vector CC from sun leaves
gmdat <- gm_c13[gm_c13$leaflight=="sun-high", "gm"]
#generate sequence and then predict
gmsun_seq <- seq(min(gmdat), max(gmdat), length=101)
gmsun_pred <- predict.lm(Agm_sun_lm, newdata=data.frame(gm=gmsun_seq), interval="confidence")

#SHADE leaves
Agm_sha_lm <- lm(Photo~ gm, data=gm_c13, subset=leaflight=="shade-low")

#get apprpriate vector CC from sun leaves
gmdat2 <- gm_c13[gm_c13$leaflight=="shade-low", "gm"]
#generate sequence and then predict
gmsha_seq <- seq(min(gmdat2), max(gmdat2), length=101)
gmsha_pred <- predict.lm(Agm_sha_lm, newdata=data.frame(gm=gmsha_seq), interval="confidence")

plot(Photo~gm, data=gm_c13, subset=leaflight=="sun-high", pch=16, col=suncol, ylim=c(0,25), 
     xlim=c(0,.45), xlab=gmlab, ylab="", cex=1.25)
ablineclip(Agm_sun_lm, lty=1, x1=min(gm_c13[gm_c13$leaf=="sun","gm"]), x2=max(gm_c13[gm_c13$leaf=="sun","gm"]), 
           col="forestgreen", lwd=2)
lines(gmsun_seq, gmsun_pred[,2], lty=2, lwd=2, col="forestgreen")
lines(gmsun_seq, gmsun_pred[,3], lty=2, lwd=2, col="forestgreen")
#shade
points(Photo~gm, data=gm_c13, subset=leaflight=="shade-low", pch=16, col=shacol, cex=1.25)

ablineclip(Agm_sha_lm, lty=1, x1=min(gm_c13[gm_c13$leaflight=="shade-low","gm"]), 
           x2=max(gm_c13[gm_c13$leaflight=="shade-low","gm"]), col="yellow4", lwd=2)
lines(gmsha_seq, gmsha_pred[,2], lty=2, lwd=2,col="yellow4")
lines(gmsha_seq, gmsha_pred[,3], lty=2, lwd=2,col="yellow4")

title(ylab=satlab, mgp=ypos, cex=1.2)
legend("topleft", leaflab2, pch=16,inset = 0.03, col=leafcol) 

```

* Here we see that there is a very slight reduction in gm with increases in temperature, but only in sun leaves

```{r}
##gm-temp
gm_ch<- summaryBy(gm+Photo+Cond+CTleaf ~id+chamber+temp+leaf+light+leaflight+Month, data=gm_water,FUN=mean,
                  keep.names=TRUE)

   
##photosynthesis and temperature
gmt_sun_lm <- lm(gm~ CTleaf, data=gm_water,subset=leaflight=="sun-high")
  sundat <- gm_water[gm_water$leaflight=="sun-high", "CTleaf"]
  sun_seq <- seq(min(sundat), max(sundat), length=101)
  sun_pred <- predict.lm(gmt_sun_lm, newdata=data.frame(CTleaf=sun_seq), interval="confidence")
  
gmt_sha_lm <- lm(gm~ CTleaf, data=gm_water,subset=leaflight=="shade-low")
  shadat <- gm_water[gm_water$leaflight=="shade-low", "CTleaf"]
  sha_seq <- seq(min(shadat), max(shadat), length=101)
  sha_pred <- predict.lm(gmt_sha_lm, newdata=data.frame(CTleaf=sha_seq), interval="confidence")

plot(gm~CTleaf, data=gm_ch, subset=leaflight=="sun-high", pch=16, col=suncol, ylim=c(0,.4), xlim=c(15, 40), 
     ylab="", xlab=leaftlab)
  
  ablineclip(gmt_sun_lm, lty=1, x1=min(gm_water[gm_water$leaf=="sun","CTleaf"]), 
             x2=max(gm_water[gm_water$leaf=="sun","CTleaf"]), col="forestgreen", lwd=2)
  lines(sun_seq, sun_pred[,2], lty=2, lwd=2, col="forestgreen")
  lines(sun_seq, sun_pred[,3], lty=2, lwd=2, col="forestgreen")
  #shade
  points(gm~CTleaf, data=gm_ch, subset=leaflight=="shade-low",pch=16, col=shacol)
  ablineclip(gmt_sha_lm, lty=1, x1=min(gm_water[gm_water$leaf=="sun","CTleaf"]), 
             x2=max(gm_water[gm_water$leaf=="sun","CTleaf"]), col="yellow4", lwd=2)
  lines(sha_seq, sha_pred[,2], lty=2, lwd=2, col="yellow4")
  lines(sha_seq, sha_pred[,3], lty=2, lwd=2, col="yellow4")
  
legend("topright", c("sun", "shade"), pch=16,inset = 0.03, col=leafcol) 
title(ylab=gmlab, mgp=ypos, cex=1.2)
```

* This figure shows the instantaneous response of gm in shade leaves when the lights are 'turned on'

```{r}
source("master_scripts/plot_objects.R")
source("functions and packages/functions.R")
library(doBy)

gmes <- read.csv("calculated_data/gmes_WTC.csv")
###for analysis first subset well watered and drought treatments
gm_drought <- gmes[gmes$drydown == "drought",]
gm_water <- gmes[gmes$drydown == "control",]

lightscol <- alpha("darkorange2", .75)
lightlab <- c(lightscol,shacol)
lightleg <- c("High light", "Low light")
##shade low-high
plot(Photo~gm, data=gm_water, subset=leaflight=="shade-high", pch=16, col=lightscol, ylim=c(0,25), xlim=c(0,.4), 
     xlab=gmlab, ylab="", cex=1.25)
points(Photo~gm, data=gm_water, subset=leaflight=="shade-low",pch=16, col=shacol, cex=1.25)
legend("topright", lightleg, pch=16,inset = 0.02, col=lightlab) 
legend("topleft", "Shade Leaves", bty='n') 
title(ylab=satlab, mgp=ypos, cex=1.2)
```



