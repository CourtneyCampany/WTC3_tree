---
title: "Sun v Shade leaves (WTCIII)"
author: "Court Campany"
date: "March 17, 2015"
output: html_document
---
```{r knitr_options , include=FALSE}
knitr::opts_chunk$set(fig.width=6, fig.height=6,
echo=FALSE, message=FALSE,
fig.align='center', warning=FALSE)
```

```{r, results='asis'}
library(knitr)
opts_knit$set(root.dir = '../')
```

```{r global data/sourcing , include=FALSE}
source("functions and packages/packages_md.R")
source("functions and packages/functions.R")
source("functions and packages/plot_objects_all.R")

gmes <- read.csv("calculated_data/gmes_WTC.csv")
gmpair<- read.csv("calculated_data/gmes_wtc_pair.csv")
gmwet <- read.csv("calculated_data/gmes_wellwatered.csv")
Ci_bar <- read.csv("calculated_data/Ci_bar.csv")
 ###for analysis first subset well watered and drought treatments
 gm_drought <- gmes[gmes$drydown == "drought",]
 gm_water <- gmes[gmes$drydown == "control",]
 
leaftraits <- read.csv("calculated_data/leaftraits_summary.csv") 
par <- read.csv("raw data/par.csv")
treatments <- read.csv("raw data/chamber_trt.csv")
 
```

### <u>Mesophyll Conducatnce</u>

* We took leaf measurements at their current temperature (ambient, +3C) for paired comparisons across leaf types at a large range of temperatures.

* Sun leaves were taken from upper canopy at their current light level.  Shade leaves were taken from lower canopy, first at their current light level and then again at sun leaf PPFD.

* g<sub>m</sub> was calculated with R<sub>d</sub> and G<sub>star</sub> generated for E.globulus.  Kristine Crous and I have compared tobacco with globulus calculations on FACE trees and they tend to lower the values of g<sub>m</sub> and generate less variance within a leaf sample. I can alter the code to generate values with tobacco parameters, if needed.

* For simplicity I have generalized most of the results below to just sun vs shade leaves (temperature not standardized).

* Further analysis is also needed to tease apart any effects of temperature treatment as data below are overall means across the 6 campaigns


####g<sub>m</sub> by leaf type and light environment

*  Below are means and standard errors of g<sub>m</sub> across all campaigns.

* Here I separated the well watered treatment from the drought treatment.  I'm more confident in the well watered values as I was often on the cutoff point with drawdown and xsi for drought leaves. They do show similar patterns but g<sub>m</sub> seems to be higher in drought trees

* Shade g<sub>m</sub> is always lower than sun leaves but when the lights are turned on they have in instantaneous response in g<sub>m</sub> that resembles sun leaves

```{r,results='asis'}
###make a table of means and se of gm
 
 gm_agg <- summaryBy(gm~ leaf+light+temp+leaflight, data=gm_water,FUN=c(mean,se))
   tablenames <- c( "Leaf Type", "Light", "Temperature","leaflight","Gm", "Gm(se)")
   names(gm_agg) <- tablenames
  gm_agg2 <- gm_agg[c(3,4,5,6,1,2),]
  row.names(gm_agg2) <- NULL

panderOptions("digits", 3)
pander(gm_agg2,caption="Well Watered")
   
  gm_dr <- summaryBy(gm~ leaf+light+temp+leaflight, data=gm_drought,FUN=c(mean,se))
    tablenames <- c( "Leaf Type", "Light", "Temperature","Leaf-Light","Gm", "Gm(se)")
    names(gm_dr) <- tablenames
  gm_dr2 <- gm_dr[c(3,4,5,6,1,2),]
  row.names(gm_dr2) <- NULL
  
pander(gm_dr2,caption="Drought")
```



```{r gm lights on}
#plot low vs high light shade leaves
plot(Photo~gm, data=gm_water, subset=leaflight=="shade-high", pch=16, col=lightscol, ylim=c(0,25), xlim=c(0,.4), 
     xlab=gmlab, ylab="", cex=1.25)
  points(Photo~gm, data=gm_water, subset=leaflight=="shade-low",pch=16, col=shacol, cex=1.25)
  legend("topright", lightleg, pch=16,inset = 0.02, col=lightlab) 
  legend("topleft", "Shade Leaves", bty='n') 
  title(ylab=satlab, mgp=ypos, cex=1.2)
```
* This figure shows the instantaneous response of g<sub>m</sub> in shade leaves when the lights are 'turned on'

```{r gm paired, fig.height=10}
wa<- palette(wes_palette("Zissou",5))
paircol <- c(wa[3], wa[1],wa[5])  
  
gmpair$variable <- as.factor(paste(gmpair$leaf, gmpair$temp, sep="-"))

gmpair2 <- gmpair[gmpair$leaflight != "shade-high",]

#paired id dfr
idDF <- data.frame(pair_id = unique(gmpair2$pair_id))

gm_id <- summaryBy(gm~ variable+pair_id, data=gmpair2, FUN=c(mean), keep.names=TRUE)
gm_sp <- dlply(gm_id, .(variable), function(x) merge(x, idDF, all = TRUE))


par(cex.axis=1.21, cex.lab=1.51,las=1,mgp=c(3.5,1,0),mfrow=c(3,1),  
    omi=c(.5,0,0.1,0.1))   
# First Panel
par(mar=c(0,7,2,2))
plot(gm_sp[[4]][,3]~gm_sp[[3]][,3], pch=21, bg=wa[3], cex=2.5, ylab="", xlab="", xlim=c(0,.5), ylim=c(0,.5),
     axes=FALSE) 
abline(0,1, lty=2)
axis(1, labels=FALSE) 
axis(2, labels=TRUE) 
box()
legend(.4,.45, pairlab[1], pch=21, pt.bg=paircol[1], pt.cex=2,bg="white",inset = 0.06)  

# Second panel   
par(mar=c(0,7,0,2))
plot(gm_sp[[1]][,3]~gm_sp[[3]][,3], pch=21, bg=wa[1], cex=2.5, ylab=gmlab, xlim=c(0,.5), ylim=c(0,.5),xlab="",
     axes=FALSE)     
abline(0,1, lty=2)
legend(.4,.45, pairlab[2], pch=21, pt.bg=paircol[2], pt.cex=2,bg="white",inset = 0.06)
axis(1, labels=FALSE) 
axis(2, labels=TRUE) 
box()

#third panel
par(mar=c(5,7,0,2))
plot(gm_sp[[2]][,3]~gm_sp[[3]][,3], pch=21, bg=wa[5], cex=2.5, ylab="", xlim=c(0,.5), ylim=c(0,.5),xlab=suatgm)   
abline(0,1, lty=2)
legend(.4,.45, pairlab[3], pch=21, pt.bg=paircol[3], pt.cex=2,bg="white",inset = 0.06) 
```
* Here is a simple version of the paired comparisons.  Only shade low light and sun leaves are used (watered and drought treatments together). All leaf types are compared to sun leaves at ambient temperature treatment (x axis)

```{r gm temp}
gm_ch<- summaryBy(gm+Photo+Cond+CTleaf ~id+chamber+temp+leaf+light+leaflight+Month, data=gm_water,FUN=mean,
                  keep.names=TRUE)
   
##photosynthesis and temperature
gmt_sun_lm <- lm(gm~ CTleaf, data=gm_water,subset=leaflight=="sun-high")
  sundat <- gm_water[gm_water$leaflight=="sun-high", "CTleaf"]
  sun_seq <- seq(min(sundat), max(sundat), length=101)
  sun_pred <- predict.lm(gmt_sun_lm, newdata=data.frame(CTleaf=sun_seq), interval="confidence")
  
gmt_sha_lm <- lm(gm~ CTleaf, data=gm_water,subset=leaflight=="shade-low")
  shadat <- gm_water[gm_water$leaflight=="shade-low", "CTleaf"]
  sha_seq <- seq(min(shadat), max(shadat), length=101)
  sha_pred <- predict.lm(gmt_sha_lm, newdata=data.frame(CTleaf=sha_seq), interval="confidence")

plot(gm~CTleaf, data=gm_ch, subset=leaflight=="sun-high", pch=16, col=suncol, ylim=c(0,.4), xlim=c(15, 40), 
     ylab="", xlab=leaftlab)
  
  ablineclip(gmt_sun_lm, lty=1, x1=min(gm_water[gm_water$leaf=="sun","CTleaf"]), 
             x2=max(gm_water[gm_water$leaf=="sun","CTleaf"]), col="forestgreen", lwd=2)
  lines(sun_seq, sun_pred[,2], lty=2, lwd=2, col="forestgreen")
  lines(sun_seq, sun_pred[,3], lty=2, lwd=2, col="forestgreen")
  #shade
  points(gm~CTleaf, data=gm_ch, subset=leaflight=="shade-low",pch=16, col=shacol)
  ablineclip(gmt_sha_lm, lty=1, x1=min(gm_water[gm_water$leaf=="sun","CTleaf"]), 
             x2=max(gm_water[gm_water$leaf=="sun","CTleaf"]), col="yellow4", lwd=2)
  lines(sha_seq, sha_pred[,2], lty=2, lwd=2, col="yellow4")
  lines(sha_seq, sha_pred[,3], lty=2, lwd=2, col="yellow4")
  
legend("topleft", c("sun", "shade"), pch=16,inset = 0.03, col=leafcol) 
title(ylab=gmlab, mgp=ypos, cex=1.2)
```
* Here we see a slight reduction in g<sub>m</sub> with increase in temperature, but only in sun leaves

### <u>Leaf Physiology</u>
* Below are figures of sun and shade leaf physiology, keeping it simple by ignoring the temperature treatment. We can address that later.


```{r A_gs}
##calculate CC
gmwet$Cc<- with(gmwet, Ci-Photo/gm)
gmwet$cc_ci<- with(gmwet, Ci/Cc)

###get average by id
gm_agg <- summaryBy(Photo+Cond+Ci+Cc+gm+VpdL+xsi+DELTA+cc_ci ~ chamber+id+leaf +light+temp+leaflight, 
                    data=gmwet, FUN=mean, keep.names=TRUE)

##remove shade-high
gm_sunsha <- gm_agg[gm_agg$leaflight != "shade-high",]
  gm_sunsha <- droplevels(gm_sunsha)
  gm_sunsha$id <- gsub("-high", "", gm_sunsha$id)
  gm_sunsha$id <- gsub("-low", "", gm_sunsha$id)

##merge
gm_c13 <- merge(gm_sunsha, Ci_bar[, c(2,8)], by="id")
  gm_c13$Cc_bar <- with(gm_c13, ci_bar-Photo/gm)

###Photosynthesis vs gs 

  ####run gam models and then predict
  #SUN leaves
  sunmod <- gam(Photo ~ s(Cond, k=5), data=gm_c13, subset=leaflight=="sun-high")
  
  #predict
  #get apprpriate vector of gs from sun leaves
  gsdat <- gm_c13[gm_c13$leaflight=="sun-high", "Cond"]
  
  #generate sequence and then predict
  gssun_seq <- seq(min(gsdat), max(gsdat), length=101)
  gssun_pred <- predict(sunmod, newdata=data.frame(Cond=gssun_seq), se.fit=TRUE)
  
  #ci and model fit
  sunupr <- gssun_pred$fit + (2*gssun_pred$se.fit)
  sunlwr <- gssun_pred$fit - (2*gssun_pred$se.fit)
  
  #SHADE leaves
  shamod <- gam(Photo ~ s(Cond, k=5), data=gm_c13, subset=leaflight=="shade-low")
  
  #get apprpriate vector CC from sun leaves
  gsdat2 <- gm_c13[gm_c13$leaflight=="shade-low", "Cond"]
  #generate sequence and then predict
  gssha_seq <- seq(min(gsdat2), max(gsdat2), length=101)
  gssha_pred <- predict(shamod, newdata=data.frame(Cond=gssha_seq), type="link", se.fit=TRUE)
  
  shaupr <- gssha_pred$fit + (2*gssha_pred$se.fit)
  shalwr <- gssha_pred$fit - (2*gssha_pred$se.fit)
  
  ###plot
  plot(Photo~Cond, data=gm_c13, subset=leaflight=="sun-high", pch=16, col=suncol, ylim=c(0,25), 
       xlim=c(0,.4), xlab=condlab, ylab="", cex=1.25)
  
  lines(gssun_seq, sunupr, lty=2, lwd=2,col=suncol)
  lines(gssun_seq, sunlwr, lty=2, lwd=2,col=suncol)
  lines(gssun_seq, gssun_pred$fit, lty=1, lwd=2,col=suncol)
  
  #shade
  points(Photo~Cond, data=gm_c13, subset=leaflight=="shade-low", pch=16, col=shacol, cex=1.25)
  lines(gssha_seq, shaupr, lty=2, lwd=2,col=shacol)
  lines(gssha_seq, shalwr, lty=2, lwd=2,col=shacol)
  lines(gssha_seq, gssha_pred$fit, lty=1, lwd=2,col=shacol)
  
  title(ylab=satlab, mgp=ypos, cex=1.2)
  legend("topleft", leaflab2, pch=16,inset = 0.03, col=leafcol) 
```  

```{r leafphys}
source("calculated_data/bootstrap/readboot.R")

###Photosynthesis vs gm
plot(Photo~gm, data=sundat, pch=16, col=suncol, ylim=c(0,25), xlim=c(0,.4), xlab=gmlab, ylab="", cex=1.25)
  points(Photo~gm, data=shadat, pch=16, col=shacol, cex=1.25)
with(agm_sun, {
  lines(gm, lcl, lty=2, lwd=2,col="forestgreen")
  lines(gm, ucl, lty=2, lwd=2,col="forestgreen")
  lines(gm, pred, lty=1, lwd=2,col="forestgreen")
})
with(agm_sha, {
  lines(gm, lcl, lty=2, lwd=2,col="yellow4")
  lines(gm, ucl, lty=2, lwd=2,col="yellow4")
  lines(gm, pred, lty=1, lwd=2,col="yellow4")
})
title(ylab=satlab, mgp=ypos, cex=1.2)
legend("topleft", leaflab2, pch=16,inset = 0.03, col=leafcol) 
  
###Photosynthesis vs Ci
plot(Photo~Ci, data=sundat, pch=16, col=suncol, ylim=c(0,25), xlim=c(0,350), xlab=cilab, ylab="", cex=1.25)
points(Photo~Ci, data=shadat, pch=16, col=shacol, cex=1.25)
with(aci_sun, {
  lines(Ci, lcl, lty=2, lwd=2,col="forestgreen")
  lines(Ci, ucl, lty=2, lwd=2,col="forestgreen")
  lines(Ci, pred, lty=1, lwd=2,col="forestgreen")
})
with(aci_sha, {
  lines(Ci, lcl, lty=2, lwd=2,col="yellow4")
  lines(Ci, ucl, lty=2, lwd=2,col="yellow4")
  lines(Ci, pred, lty=1, lwd=2,col="yellow4")
})
title(ylab=satlab, mgp=ypos, cex=1.2)
legend("topleft", leaflab2, pch=16,inset = 0.03, col=leafcol) 
  
 ###Photosynthesis vs Cc 
  plot(Photo~Cc, data=sundat, pch=16, col=suncol, ylim=c(0,25), xlim=c(0,350), xlab=cclab, ylab="", cex=1.25)
  points(Photo~Cc, data=shadat, pch=16, col=shacol, cex=1.25)
  with(acc_sun, {
    lines(Cc, lcl, lty=2, lwd=2,col="forestgreen")
    lines(Cc, ucl, lty=2, lwd=2,col="forestgreen")
    lines(Cc, pred, lty=1, lwd=2,col="forestgreen")
  })
  with(acc_sha, {
    lines(Cc, lcl, lty=2, lwd=2,col="yellow4")
    lines(Cc, ucl, lty=2, lwd=2,col="yellow4")
    lines(Cc, pred, lty=1, lwd=2,col="yellow4")
  })
  title(ylab=satlab, mgp=ypos, cex=1.2)
  legend("topleft", leaflab2, pch=16,inset = 0.03, col=leafcol) 
```

* Photosynthesis and Ci calculated from leaf ${\delta}$^13^C

```{r cibar}
###Photosynthesis vs cibar
plot(Photo~ci_bar, data=sundat, pch=16, col=suncol, ylim=c(0,25), 
     xlim=c(0,350), xlab=cibarlab2, ylab="", cex=1.25)
#shade
points(Photo~ci_bar, data=shadat, pch=16, col=shacol, cex=1.25)
  with(acib_sun, {
    lines(ci_bar, lcl, lty=2, lwd=2,col="forestgreen")
    lines(ci_bar, ucl, lty=2, lwd=2,col="forestgreen")
    lines(ci_bar, pred, lty=1, lwd=2,col="forestgreen")
  })
  with(acib_sha, {
    lines(ci_bar, lcl, lty=2, lwd=2,col="yellow4")
    lines(ci_bar, ucl, lty=2, lwd=2,col="yellow4")
    lines(ci_bar, pred, lty=1, lwd=2,col="yellow4")
  })
title(ylab=satlab, mgp=ypos, cex=1.2)
legend("topleft", leaflab2, pch=16,inset = 0.03, col=leafcol) 
```

### <u>Shade versus Sun leaves</u>

This set of figures attempts to show how sun and shade leaves were fundamentally different.  

  

```{r, results='asis'}
aci_leaf <- read.csv("calculated_data/tdl_aci.csv")
names(aci_leaf) <-c("Leaf", "Temperature", "Vcmax", "Jmax", "Vcmax_se", "Jmax_se")

aci_leaf2 <- aci_leaf[,c(1,2,3,5,4,6)]

panderOptions("digits", 3)
pander(aci_leaf2, caption="Leaf Biochemistry")
```    
* ACi curves were measured at saturating light for both sun and shade leaves. 
  

```{r,results='asis'}
  #simulate ACi curves for each leaf, ambient and elevated T
  sunAT_sim <- Aci(Ci=seq(50,1000,length=101), Vcmax=aci_leaf[3,3], Jmax=aci_leaf[3,4],PPFD=1408)
  sunET_sim <- Aci(Ci=seq(50,1000,length=101), Vcmax=aci_leaf[4,3], Jmax=aci_leaf[4,4], PPFD=1408)
  shaAT_sim <- Aci(Ci=seq(50,1000,length=101), Vcmax=aci_leaf[1,3], Jmax=aci_leaf[1,4], PPFD=375)
  shaET_sim <- Aci(Ci=seq(50,1000,length=101), Vcmax=aci_leaf[2,3], Jmax=aci_leaf[2,4],PPFD=375)

#plot
plot(sunAT_sim$Ci, sunAT_sim$ALEAF, col="forestgreen", pch=21,  cex=1.1,xlab=cilab, ylab="", type="l", lwd=2)
  points(sunET_sim$Ci, sunET_sim$ALEAF, col="forestgreen", pch=21,  cex=1.1,xlab="Ci", ylab="", type="l", lwd=2, lty=2)
  points(shaAT_sim$Ci, shaAT_sim$ALEAF, col="yellowgreen", pch=21,  cex=1.1,xlab="Ci", ylab="", type="l", lwd=2)
  points(shaET_sim$Ci, shaET_sim$ALEAF, col="yellowgreen", pch=21,  cex=1.1,xlab="Ci", ylab="", type="l", lwd=2, lty=2)
  legend("bottomright", leglab2, lty=c(1,2,1,2), lwd=2,col=colaci, pt.bg=col4,inset = 0.03)
  title(ylab=satlab, mgp=ypos)
```
* Here are predicted ACi curves for leaf types with temperature treatments. Both Vc<sub>max</sub> and J<sub>max</sub> are reduced in shade leaves with little effect of the temperature treatment. ACi curves were taken once towards the end of the experiment on well watered trees.


```{r,results='asis'}
##this has droughtleaves
palette(c("yellowgreen", "green4"))
par(mar=c(5,5,2,2))
plot(c13.mean ~ leafN_area.mean, data=leaftraits, pch=16, col=as.factor(leaf), ylim=c(-35,-25), 
                 xlim=c(1,3.5), cex=1.25, xlab=narealab, ylab=c13lab)
legend("bottomright", leaflab, pch=16, col=c("yellowgreen", "green4"),pt.cex=1.5,inset = 0.03)  

```
* This figure shows the relationship between leaf N on an area basis and ${\delta}$^13^C between leaf types (chamber means).



```{r,results='asis'}
 #format function
 par<- parformat(par)
 
 par_leaf <- subset(par, ID !="shade-high")
 Morder <- c("Oct", "Dec", "Jan", "Feb", "Mar", "Apr")
 
 #data format for bar
 parbar <- subset(par_leaf, select = c("par", "month", "leaf_type"))
 parbar$month <- factor(parbar$month, levels = Morder)
 
 
 bar(par, c(leaf_type, month), parbar, col=c("yellowgreen", "green4"), xlab="", ylab="", ylim=c(0, 2000), 
     half.errbar=FALSE)
 title(ylab=parlab, mgp=ypos)
```

* Next is the light environment in which gas exchange measurements for sun and shade leaves were measured.  This data was generated with a handheld par sensor for each individual leaf and verified with ceptometer readings within the canopy at the height of the measured leaf. There was a ~75% reduction in PPFD from sun to shave leaves.

```{r}
 ###LMA-
 lma <- read.csv("calculated_data/leaf_chemistry.csv")
 
 #data format for bar
 lmabar <- subset(lma, select = c("lma", "Month", "leaf"))
   lmabar$Month <- factor(lmabar$Month, levels = Morder)
 
 bar(lma, c(leaf, Month), lmabar, col=c("yellowgreen", "green4"), xlab="", ylab="", ylim=c(0, 185), half.errbar=FALSE)
 title(ylab=lmalab, mgp=ypos)
```

* The second figure shows leaf mass area for each gas exchange campaign.  Surprisingly, not very different. 