---
title: "Sun vs Shade leaves (WTCIII)"
author: "Court Campany"
date: "April 1, 2015"
output: html_document
---
```{r knitr_options , include=FALSE}
knitr::opts_chunk$set(fig.width=6, fig.height=6,
echo=FALSE, message=FALSE,
fig.align='center', warning=FALSE)
```

```{r, results='asis'}
library(knitr)
opts_knit$set(root.dir = '../')
```

```{r global data/sourcing , include=FALSE}
source("functions and packages/packages_md.R")
source("functions and packages/functions.R")
source("functions and packages/plot_objects_all.R")

gmes <- read.csv("calculated_data/gmes_WTC.csv")
gmpair<- read.csv("calculated_data/gmes_wtc_pair.csv")
gmwet <- read.csv("calculated_data/gmes_wellwatered.csv")
Ci_bar <- read.csv("calculated_data/Ci_bar.csv")
 ###for analysis first subset well watered and drought treatments
 gm_drought <- gmes[gmes$drydown == "drought",]
 gm_water <- gmes[gmes$drydown == "control",]
 
leaftraits <- read.csv("calculated_data/leaftraits_summary.csv") 
par <- read.csv("raw data/par.csv")
treatments <- read.csv("raw data/chamber_trt.csv")
 
```

#### <u>Design</u>
* WTCIII was a warming experiemnt with ambient and +3°C warming (n=6).  A drought manipulation was added in the last few months of the experiment.
* Sun leaves were measured in the upper canopy at their current PPFD.  Shade leaves were measured in the lower canopy, first at their current PPFD and then again at sun leaf PPFD.
* New fully expanded leaves were measured. Shade leaves were sampled into the middle canopy as the experiment progressed to avoid issues with leaf age.
* Leaf physiological measurements were taken at their current temperature (ambient, +3°C) for paired comparisons across leaf types. Thus, data below represent a large range of temperatures from ~18-35°C.
* For simplicity I have generalized most of the results below to just sun vs. shade leaves. So effects of the warming treatment are often not included and there is no standarizatiopn of leaf temperature.
* Unless it is explicitly stated I have left off the drought treatment as well.  
* Data below are mostly overall means across the 6 campaigns.  We can tease apart temperature/drought effects later.  

#### <u>Were Sun and Shade leaves actually different?</u>

```{r, results='asis'}
aci_leaf <- read.csv("calculated_data/tdl_aci.csv")
names(aci_leaf) <-c("Leaf", "Temperature", "Vcmax", "Jmax", "Vcmax_se", "Jmax_se")

aci_leaf2 <- aci_leaf[,c(1,2,3,5,4,6)]

panderOptions("digits", 3)
pander(aci_leaf2, caption="Leaf Biochemistry")
```    

  
```{r,results='asis'}
  #simulate ACi curves for each leaf, ambient and elevated T
  sunAT_sim <- Aci(Ci=seq(50,1000,length=101), Vcmax=aci_leaf[3,3], Jmax=aci_leaf[3,4],PPFD=1408)
  sunET_sim <- Aci(Ci=seq(50,1000,length=101), Vcmax=aci_leaf[4,3], Jmax=aci_leaf[4,4], PPFD=1408)
  shaAT_sim <- Aci(Ci=seq(50,1000,length=101), Vcmax=aci_leaf[1,3], Jmax=aci_leaf[1,4], PPFD=375)
  shaET_sim <- Aci(Ci=seq(50,1000,length=101), Vcmax=aci_leaf[2,3], Jmax=aci_leaf[2,4],PPFD=375)

#plot
plot(sunAT_sim$Ci, sunAT_sim$ALEAF, col="forestgreen", pch=21,  cex=1.1,xlab=cilab, ylab="", type="l", lwd=2, ylim=c(0,30))
  points(sunET_sim$Ci, sunET_sim$ALEAF, col="forestgreen", pch=21,  cex=1.1,xlab="Ci", ylab="", type="l", lwd=2, lty=2)
  points(shaAT_sim$Ci, shaAT_sim$ALEAF, col="yellow4", pch=21,  cex=1.1,xlab="Ci", ylab="", type="l", lwd=2)
  points(shaET_sim$Ci, shaET_sim$ALEAF, col="yellow4", pch=21,  cex=1.1,xlab="Ci", ylab="", type="l", lwd=2, lty=2)
  legend("bottomright", leglab2, lty=c(1,2,1,2), lwd=2,col=colaci, pt.bg=col4,inset = 0.03)
  title(ylab=satlab, mgp=ypos)
```

* ACi curves were measured at saturating light for both sun and shade leaves. 
* Here are predicted ACi curves for leaf types with temperature treatments. Both Vc<sub>max</sub> and J<sub>max</sub> are reduced in shade leaves with little effect of the temperature treatment. ACi curves were taken once towards the end of the experiment on well watered trees

#### <u>Mesophyll Conducatnce</u>

* g<sub>m</sub> was calculated with R<sub>d</sub> and G<sub>star</sub> generated for E.globulus.  Kristine Crous and I have compared tobacco with globulus calculations on FACE trees and they tend to lower the values of g<sub>m</sub> and generate less variance within a leaf sample. I can alter the code to generate values with tobacco parameters, if needed.

#### g<sub>m</sub> by leaf type and light environment

* The two tables below are means and standard errors of g<sub>m</sub> across all campaigns.

* The well-watered treatment from the drought treatment are seperated.  I'm more confident in the well-watered values as I was often on the cutoff point with drawdown and xsi for drought leaves. They do show similar patterns but g<sub>m</sub> seems to be higher in drought trees

* Shade leaf g<sub>m</sub> is always lower than sun leaves but when the lights are 'turned on' they have in instantaneous response in g<sub>m</sub> that resembles sun leaves.

```{r,results='asis'}
###make a table of means and se of gm
 
 gm_agg <- summaryBy(gm~ leaf+light+temp+leaflight, data=gm_water,FUN=c(mean,se))
   tablenames <- c( "Leaf Type", "Light", "Temperature","leaflight","Gm", "Gm(se)")
   names(gm_agg) <- tablenames
  gm_agg2 <- gm_agg[c(3,4,5,6,1,2),]
  row.names(gm_agg2) <- NULL

panderOptions("digits", 3)
pander(gm_agg2,caption="Well Watered")
   
  gm_dr <- summaryBy(gm~ leaf+light+temp+leaflight, data=gm_drought,FUN=c(mean,se))
    tablenames <- c( "Leaf Type", "Light", "Temperature","Leaf-Light","Gm", "Gm(se)")
    names(gm_dr) <- tablenames
  gm_dr2 <- gm_dr[c(3,4,5,6,1,2),]
  row.names(gm_dr2) <- NULL
  
pander(gm_dr2,caption="Drought")
```


```{r gm lights on}
#plot low vs high light shade leaves
plot(Photo~gm, data=gm_water, subset=leaflight=="shade-high", pch=16, col=lightscol, ylim=c(0,30), xlim=c(0,.4), 
     xlab=gmlab, ylab="", cex=1.25)
  points(Photo~gm, data=gm_water, subset=leaflight=="shade-low",pch=16, col=shacol, cex=1.25)
  legend("topright", lightleg, pch=16,inset = 0.02, col=lightlab) 
  legend("topleft", "Shade Leaves", bty='n') 
  title(ylab=satlab, mgp=ypos, cex=1.2)
```

* This figure shows the instantaneous response of g<sub>m</sub> in shade leaves when the lights are 'turned on'.   

```{r gm paired, fig.height=10}
wa<- palette(wes_palette("Zissou",5))
paircol <- c(wa[3], wa[1],wa[5])  
  
gmpair$variable <- as.factor(paste(gmpair$leaf, gmpair$temp, sep="-"))

gmpair2 <- gmpair[gmpair$leaflight != "shade-high",]

#paired id dfr
idDF <- data.frame(pair_id = unique(gmpair2$pair_id))

gm_id <- summaryBy(gm~ variable+pair_id, data=gmpair2, FUN=c(mean), keep.names=TRUE)
gm_sp <- dlply(gm_id, .(variable), function(x) merge(x, idDF, all = TRUE))


par(cex.axis=1.21, cex.lab=1.51,las=1,mgp=c(3.5,1,0),mfrow=c(3,1),  
    omi=c(.5,0,0.1,0.1))   
# First Panel
par(mar=c(0,7,2,2))
plot(gm_sp[[4]][,3]~gm_sp[[3]][,3], pch=21, bg=wa[3], cex=2.5, ylab="", xlab="", xlim=c(0,.4), ylim=c(0,.4),
     axes=FALSE) 
abline(0,1, lty=2)
axis(1, labels=FALSE) 
axis(2, labels=TRUE) 
box()
legend(.3,.35, pairlab[1], pch=21, pt.bg=paircol[1], pt.cex=2,bg="white",inset = 0.06)  

# Second panel   
par(mar=c(0,7,0,2))
plot(gm_sp[[1]][,3]~gm_sp[[3]][,3], pch=21, bg=wa[1], cex=2.5, ylab=gmlab, xlim=c(0,.4), ylim=c(0,.4),xlab="",
     axes=FALSE)     
abline(0,1, lty=2)
legend(.3,.35, pairlab[2], pch=21, pt.bg=paircol[2], pt.cex=2,bg="white",inset = 0.06)
axis(1, labels=FALSE) 
axis(2, labels=TRUE) 
box()

#third panel
par(mar=c(5,7,0,2))
plot(gm_sp[[2]][,3]~gm_sp[[3]][,3], pch=21, bg=wa[5], cex=2.5, ylab="", xlim=c(0,.4), ylim=c(0,.4),xlab=suatgm)   
abline(0,1, lty=2)
legend(.3,.35, pairlab[3], pch=21, pt.bg=paircol[3], pt.cex=2,bg="white",inset = 0.06) 
```

* Here is a simple version of the paired leaf comparisons.  Shade low light and sun leaves are used (watered and drought treatments are combined). Leaf types (with temperature treatment) are compared to sun leaves at ambient temperature as the control treatment (x axis).

```{r gm temp}
gm_ch<- summaryBy(gm+Photo+Cond+CTleaf ~id+chamber+temp+leaf+light+leaflight+Month, data=gm_water,FUN=mean,
                  keep.names=TRUE)
   
##photosynthesis and temperature
gmt_sun_lm <- lm(gm~ CTleaf, data=gm_water,subset=leaflight=="sun-high")
  sundat <- gm_water[gm_water$leaflight=="sun-high", "CTleaf"]
  sun_seq <- seq(min(sundat), max(sundat), length=101)
  sun_pred <- predict.lm(gmt_sun_lm, newdata=data.frame(CTleaf=sun_seq), interval="confidence")
  
gmt_sha_lm <- lm(gm~ CTleaf, data=gm_water,subset=leaflight=="shade-low")
  shadat <- gm_water[gm_water$leaflight=="shade-low", "CTleaf"]
  sha_seq <- seq(min(shadat), max(shadat), length=101)
  sha_pred <- predict.lm(gmt_sha_lm, newdata=data.frame(CTleaf=sha_seq), interval="confidence")

plot(gm~CTleaf, data=gm_ch, subset=leaflight=="sun-high", pch=16, col=suncol, ylim=c(0,.4), xlim=c(15, 40), 
     ylab="", xlab=leaftlab)
  
  ablineclip(gmt_sun_lm, lty=1, x1=min(gm_water[gm_water$leaf=="sun","CTleaf"]), 
             x2=max(gm_water[gm_water$leaf=="sun","CTleaf"]), col="forestgreen", lwd=2)
  lines(sun_seq, sun_pred[,2], lty=2, lwd=2, col="forestgreen")
  lines(sun_seq, sun_pred[,3], lty=2, lwd=2, col="forestgreen")
  #shade
  points(gm~CTleaf, data=gm_ch, subset=leaflight=="shade-low",pch=16, col=shacol)
  ablineclip(gmt_sha_lm, lty=1, x1=min(gm_water[gm_water$leaf=="sun","CTleaf"]), 
             x2=max(gm_water[gm_water$leaf=="sun","CTleaf"]), col="yellow4", lwd=2)
  lines(sha_seq, sha_pred[,2], lty=2, lwd=2, col="yellow4")
  lines(sha_seq, sha_pred[,3], lty=2, lwd=2, col="yellow4")
  
legend("topleft", c("sun", "shade"), pch=16,inset = 0.03, col=leafcol) 
title(ylab=gmlab, mgp=ypos, cex=1.2)
```

* This figure shows the relationship between g<sub>m</sub> and temperature with 95% confidence intervals.  Here we see a slight reduction in g<sub>m</sub> with increases in temperature, but only significant in sun leaves.

### <u>Sun vs. Shade Leaf Physiology</u>

```{r A_gs, fig.width=12, fig.height=6}
source("markdown/ags_plots.R")
```  

* Figures of photosynthesis and g<sub>s</sub>.  Panel (a) is shown with 95% confidence intervals.  Panel (b) shows predicted photosynthesis rates generated with g<sub>s</sub> values, mean leaf temperature and PPFD (sun/shade), and ACi parameters including ambient and elevated temperature treatments. Here we can see optimal stomatal behaviour in sun leaves but not in shade leaves.

```{r a-gm, }
source("calculated_data/bootstrap/readboot.R")
  ###Photosynthesis vs gm
plot(Photo~gm, data=sundat, pch=16, col=suncol, ylim=c(0,30), xlim=c(0,.4), xlab=gmlab, ylab="", cex=1.25)
  points(Photo~gm, data=shadat, pch=16, col=shacol, cex=1.25)
with(agm_sun, {
  lines(gm, lcl, lty=2, lwd=2,col="forestgreen")
  lines(gm, ucl, lty=2, lwd=2,col="forestgreen")
  lines(gm, pred, lty=1, lwd=2,col="forestgreen")
})
with(agm_sha, {
  lines(gm, lcl, lty=2, lwd=2,col="yellow4")
  lines(gm, ucl, lty=2, lwd=2,col="yellow4")
  lines(gm, pred, lty=1, lwd=2,col="yellow4")
})
title(ylab=satlab, mgp=ypos, cex=1.2)
legend("topleft", leaflab2, pch=16,inset = 0.03, col=leafcol) 
```

* This figure shows the relationship between photosynthesis and g<sub>m</sub> for sun and shade leaves with 95% confidence intervals.

```{r leafphys,fig.width=12, fig.height=6}
###Photosynthesis vs Ci
  shade <- gm_c13[gm_c13$leaf=="shade",]
  sun <- gm_c13[gm_c13$leaf=="sun",]
  
  #read in jmax vcmax
  jvc<- read.csv("calculated_data/tdl_aci.csv")

  
  #simulate ACi curves for each leaf, ambient and elevated T
  sunAT_sim <- Aci(Ci=seq(50,1000,length=101), Vcmax=jvc[3,3], Jmax=jvc[3,4],PPFD=1407.959)
  sunET_sim <- Aci(Ci=seq(50,1000,length=101), Vcmax=jvc[4,3], Jmax=jvc[4,4], PPFD=1407.959)
  shaAT_sim <- Aci(Ci=seq(50,1000,length=101), Vcmax=jvc[1,3], Jmax=jvc[1,4], PPFD=305)
  shaET_sim <- Aci(Ci=seq(50,1000,length=101), Vcmax=jvc[2,3], Jmax=jvc[2,4],PPFD=305)  
  
  
par(cex.axis=.96, cex.lab=1.2,mfrow=c(1,2),oma=c(0.1,0.1,0.1,0.1), las=1) 

par(mar=c(5,4,2,0))
plot(Photo~Ci, data=sundat, pch=16, col=suncol, ylim=c(0,30), xlim=c(0,350), xlab=cilab, ylab="", cex=1.25)
points(Photo~Ci, data=shadat, pch=16, col=shacol, cex=1.25)
with(aci_sun, {
  lines(Ci, lcl, lty=2, lwd=2,col="forestgreen")
  lines(Ci, ucl, lty=2, lwd=2,col="forestgreen")
  lines(Ci, pred, lty=1, lwd=2,col="forestgreen")
})
with(aci_sha, {
  lines(Ci, lcl, lty=2, lwd=2,col="yellow4")
  lines(Ci, ucl, lty=2, lwd=2,col="yellow4")
  lines(Ci, pred, lty=1, lwd=2,col="yellow4")
})
title(ylab=satlab, mgp=ypos, cex=1.2)
legend("topright", leaflab2, pch=16,inset = 0.03, col=leafcol) 
text(x=.01, 29.5, "(a)", cex=1.2)
  
par(mar=c(5,2.5,2,2)) 
plot(sunAT_sim$Ci, sunAT_sim$ALEAF, col="forestgreen", pch=21,  cex=1.1,xlab=cilab, ylab="", type="l",  lwd=2,ylim=c(0,30), xlim=c(0,1000))
  points(sunET_sim$Ci, sunET_sim$ALEAF, col="forestgreen", pch=21,  cex=1.1,xlab="Ci", ylab="", type="l", lwd=2, lty=2)
  points(shaAT_sim$Ci, shaAT_sim$ALEAF, col="yellow4", pch=21,  cex=1.1,xlab="Ci", ylab="", type="l", lwd=2)
  points(shaET_sim$Ci, shaET_sim$ALEAF, col="yellow4", pch=21,  cex=1.1,xlab="Ci", ylab="", type="l", lwd=2, lty=2)
  points(Photo~Ci, data=sundat, pch=16, col=suncol, cex=1.25)
  points(Photo~Ci, data=shadat, pch=16, col=shacol, cex=1.25)
  
  legend("bottomright", leglab2, lty=c(1,2,1,2), lwd=2,col=colaci, pt.bg=col4,inset = 0.03)
  text(x=.01, 29.5, "(b)", cex=1.2)
```

* These figures show the relationship of photosynthesis to Ci. Panel (a) has 95% confidence intervals.  Panel (b) has the predicted ACi curves using the biochemical parameters measured at saturating light but fitted with mean PPFD of sun and shade leaves.

```{r}
 ###Photosynthesis vs Cc 
  plot(Photo~Cc, data=sundat, pch=16, col=suncol, ylim=c(0,30), xlim=c(0,350), xlab=cclab, ylab="", cex=1.25)
  points(Photo~Cc, data=shadat, pch=16, col=shacol, cex=1.25)
  with(acc_sun, {
    lines(Cc, lcl, lty=2, lwd=2,col="forestgreen")
    lines(Cc, ucl, lty=2, lwd=2,col="forestgreen")
    lines(Cc, pred, lty=1, lwd=2,col="forestgreen")
  })
  with(acc_sha, {
    lines(Cc, lcl, lty=2, lwd=2,col="yellow4")
    lines(Cc, ucl, lty=2, lwd=2,col="yellow4")
    lines(Cc, pred, lty=1, lwd=2,col="yellow4")
  })
  title(ylab=satlab, mgp=ypos, cex=1.2)
  legend("topleft", leaflab2, pch=16,inset = 0.03, col=leafcol) 
```

* This figures show the relationship of photosynthesis to Cc with 95% confidence intervals, calculated with g<sub>m</sub> data


### <u>Shade versus Sun leaves, continued</u>

This next set of figures attempts to show how sun and shade leaves were fundamentally different.  

```{r,results='asis'}
##this has droughtleaves
palette(c("yellow4", "forestgreen"))
par(mar=c(5,5,2,2))
plot(c13.mean ~ leafN_area.mean, data=leaftraits, pch=16, col=as.factor(leaf), ylim=c(-35,-25), 
                 xlim=c(1,3.5), cex=1.25, xlab=narealab, ylab=c13lab)
legend("bottomright", leaflab, pch=16, col=c("yellow4", "green4"),pt.cex=1.5,inset = 0.03)  

```

* This figure shows the relationship between leaf N on an area basis and ${\delta}$^13^C between leaf types (chamber means).

```{r,results='asis'}
 #format function
 par<- parformat(par)
 
 par_leaf <- subset(par, ID !="shade-high")
 Morder <- c("Oct", "Dec", "Jan", "Feb", "Mar", "Apr")
 
 #data format for bar
 parbar <- subset(par_leaf, select = c("par", "month", "leaf_type"))
 parbar$month <- factor(parbar$month, levels = Morder)
 
 
 bar(par, c(leaf_type, month), parbar, col=c("yellow4", "forestgreen"), xlab="", ylab="", ylim=c(0, 2000), 
     half.errbar=FALSE)
 title(ylab=parlab, mgp=ypos)
```

* Next is the light environment in which gas exchange measurements for sun and shade leaves were measured.  This data was generated with a handheld par sensor for each individual leaf and verified with ceptometer readings within the canopy at the height of the measured leaf. There was a ~75% reduction in PPFD from sun to shave leaves.

```{r}
 ###LMA-
 lma <- read.csv("calculated_data/leaf_chemistry.csv")
 
 #data format for bar
 lmabar <- subset(lma, select = c("lma", "Month", "leaf"))
   lmabar$Month <- factor(lmabar$Month, levels = Morder)
 
 bar(lma, c(leaf, Month), lmabar, col=c("yellow4", "forestgreen"), xlab="", ylab="", ylim=c(0, 185), half.errbar=FALSE)
 title(ylab=lmalab, mgp=ypos)
```

* This figure shows leaf mass area for each gas exchange campaign.  Surprisingly, not very different between leaf types. 